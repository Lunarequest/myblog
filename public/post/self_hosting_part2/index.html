<!doctype html><html lang=en-us><head><meta charset=utf-8><title>Self hosting part 2</title><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><link rel=alternate type=application/rss+xml href=https://nullrequest.com/index.xml title="Null's blog"><link id=dark-mode-theme rel=stylesheet href=https://nullrequest.com/css/dark.css><link rel=stylesheet href=https://nullrequest.com/fontawesome/css/all.min.css><script src=https://nullrequest.com/js/bundle.js></script><script src=https://nullrequest.com/js/instantpage.js type=module defer></script><meta name=generator content="Hugo 0.74.3"></head><body><header><nav class=navbar><div class=nav><a href=https://nullrequest.com/ class=nav-logo><img src=https://nullrequest.com/images/icon.jpg width=50 height=50 alt=Logo></a><ul class=nav-links><li><a href=https://nullrequest.com/about/ name=About><i class="fas fa-user fa-lg"></i></a></li><li><a href=https://nullrequest.com/search name=Search><i class="fas fa-search fa-lg"></i></a></li></ul></div></nav><div class=intro-header><div class=container><div class=post-heading><h1>Self hosting part 2</h1><span class=meta-post><i class="fa fa-calendar-alt"></i>&nbsp;Aug 29, 2020</span></div></div></div></header><div class=container role=main><article class=article class=blog-post><h2 id=background>Background</h2><p>This is a continuation of the previous post. This will be part 2 of 3 hopefully if I can get my custom tools working. Alot has changed since last post. If you are reading this on the netlify subdomain please head over to <a href=http://nullrequest.com>http://nullrequest.com</a> and continue reading. The linked website is curently running on my own hardware!!!!! Before I continue big thanks to <a href=https://emalm.com>sesa</a>. She really helped my with my nginx configs.</p><h2 id=the-three-stages>The three stages?????</h2><p>Yeah my 3 stages plan went sort of bupkis when I relasied I could only test once I deployed everything but that doesn&rsquo;t mean I haven&rsquo;t worked on the custom tooling at all. Infact if you check out my github you&rsquo;ll find the cloudflare-DDNS repo. This is hopfully the start of a script that should allow use to update the ip without ever having to touch the dashboard on cloudflare. If you have a pfsense box pfsense can actually handle it for you. I may get one in the future but until then its no dice. I&rsquo;ll take about how I deployed everything in this post.</p><h2 id=nginx>Nginx</h2><p>Nginx is sort of like the holy grail for us right now. If we had embarked on this project before 2004 we would have had to use Apache. While there is nothing inherntly wrong with apache its very very difficult to setup. So then smooth sailing? well no. Nginx on arch is the bare minimum ngnix distribution. It makes things interesting if you like a challange. If not use ubuntu and yeah alot of steps can be skipped. I can&rsquo;t tell you what steps but go through you should be able to figure it out. On arch linux there are 2 versions of nginx. I recomand the mainline version as it will have the latest features. The bellow command should install nginx mainline.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#75715e># pacman -S nginx-mainline</span>
</code></pre></div><p>Before we start we need to &ldquo;minify&rdquo; all html and css so ngnix can serve the files. Hugo saves us alot of time as it has a simple command to create all the html in a minified form. This means there are no spaces in the html.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>
$ hugo --gc --minify -b url

</code></pre></div><p>Replace url with you url. After the command finishes it will create a folder called public. It will have all the html and css needed to deploy the website. I copied all the files to <code>/var/www/nameofwebsite</code> and changed the ownership of the files using <code>chown</code> to the http user.</p><h2 id=configs>configs</h2><p>ngnix on arch needs some modifications to a few files to make it simpler to deploy websites and services. First we need to edit <code>ngnix.conf</code> on other linux distros you might make a config at sites-avalible and symlink it to sites-enabled however arch actually doesn&rsquo;t load the server blocks in sites-enabled. However making arch load it is pretty simple. Open <code>/etc/nginx/nginx.conf</code> in a text editor of your choice and add this too the http block</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nginx data-lang=nginx>
<span style=color:#66d9ef>include</span> sites-enabled/*;

</code></pre></div><p>Next up we can create sites-enabled and sites-avalible. You can do this however you want but I am partial to <code>mkdir</code>.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#75715e># mkdir /etc/nginx/sites-avalible</span>
<span style=color:#75715e># mkdir /etc/nginx/sites-enabled</span>
</code></pre></div><p>Now we can make our first &ldquo;server block&rdquo;, A server block esstentially means based on the url or ip address used we can decied what to do with the request. This means you can run multiple websites of the same server with little too no conflicts. To start lets make a site in sites-avalible.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#75715e># touch /etc/nginx/sites-avalible/myblog</span>
</code></pre></div><p>Before we continue with setting up nginx lets setup cloudflare and get a origin cert. First lets head to <a href=https://www.canyouseeme.org/>https://www.canyouseeme.org/</a>. This service should get you your public ip. <strong>This will change over time</strong>. You may need to update your dns records to reflect your new ip when your ip changes. Get your public IP adress. You need to setup cloudflare with your domain and change TLS to full. Next get a origin cert from cloudflare. You will get a certificate and a key. copy the certifcate text to <code>/etc/ssl/youdoaminahere.pem</code> and the key to <code>/etc/ssl/yourdomainhere.key</code></p><p>Now we need to open the file in a texteditor. I used vim but you can use what texteditor you are comfortable with. Now we can configure everything in ngnix.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nginx data-lang=nginx><span style=color:#66d9ef>server</span> {
        <span style=color:#f92672>listen</span> <span style=color:#ae81ff>443</span> <span style=color:#e6db74>ssl</span>;
        <span style=color:#f92672>server_name</span> <span style=color:#e6db74>yourdomainhere</span>;
        <span style=color:#f92672>ssl_certificate</span>    <span style=color:#e6db74>/etc/ssl/youdomainhere.pem</span>;
        <span style=color:#f92672>ssl_certificate_key</span>    <span style=color:#e6db74>/etc/ssl/yourdomainhere.key</span>;
        <span style=color:#f92672>access_log</span> <span style=color:#e6db74>/var/log/nginx/nginx.vhost.access.log</span>;
        <span style=color:#f92672>error_log</span> <span style=color:#e6db74>/var/log/nginx/nginx.vhost.error.log</span>;

        <span style=color:#f92672>root</span> <span style=color:#e6db74>/var/www/yourdomainhere</span>;
        <span style=color:#f92672>index</span> <span style=color:#e6db74>index.html</span> <span style=color:#e6db74>index.htm</span>;

        <span style=color:#f92672>location</span> <span style=color:#e6db74>/</span> {
                <span style=color:#f92672>try_files</span> $uri $uri/ =<span style=color:#ae81ff>404</span>;
        }
        <span style=color:#f92672>error_page</span> <span style=color:#ae81ff>404</span> <span style=color:#ae81ff>404</span><span style=color:#e6db74>.html</span>;
}
</code></pre></div><p>I know this alot to process but I&rsquo;ll break everything down line by line.
<code>server {</code> the first line tell ngnix whats follows is a server block. <code>listen 443 ssl;</code> This tells nginx to listen on port 443 and use ssl. The next line tells nginx that this block is realted to your domain and not use it for other ones. The next 2 lines are for https. Nginx needs to know where to get the cert and key.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nginx data-lang=nginx><span style=color:#66d9ef>access_log</span> <span style=color:#e6db74>/var/log/nginx/nginx.vhost.access.log</span>;
<span style=color:#66d9ef>error_log</span> <span style=color:#e6db74>/var/log/nginx/nginx.vhost.error.log</span>;
</code></pre></div><p>These lines bassically tell nginx where to wrtie logs too. These can be pretty interesting to go through. <strong>REMEMBER LOGS ARE YOUR BEST FREIND WHEN DEBUGGING</strong>. <code>root /var/www/yourdomainhere;</code> this line bassically tells nginx which directory the files are located saving you the hassel of using absolute paths. <code>index index.html index.htm;</code> If you have been paying attention you should be able to guess that this line tells nginx to server index.html or index.htm based on what exists when someone acess the raw url.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nginx data-lang=nginx><span style=color:#66d9ef>location</span> <span style=color:#e6db74>/</span> {
        <span style=color:#f92672>try_files</span> $uri $uri/ =<span style=color:#ae81ff>404</span>;
        }
</code></pre></div><p>This section is a bit simple logic that says in simple terms look for a file or path that the url has. Serve the file if you find it. If you don&rsquo;t return a 404 error code. <code>error_page 404 404.html;</code> The last line tells nginx that if you have a 404 serve the 404.html document to the user.</p><p>After this you can run the following command to check if there are errors in your code.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#75715e># nginx -t</span>
</code></pre></div><p>With this we can finish our configs and start the nginx service.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ systemctl start nginx
</code></pre></div><h2 id=port-forwading>Port forwading</h2><p>This part is basically the last step to deploying our website. This step will change for your router you should be able to setup everything pretty simply. you need to forward 443 on LAN to WAN and with that you should have a working website. You can check if everything works using <a href=https://www.canyouseeme.org/>https://www.canyouseeme.org/</a>. You can set the port to 443.</p><p>The next post will be about my work with custom tools that I will be making. If you are still on the old url comments will not work. I will be keeping the website up for a month or two before taking the old url down.</p><p>— This is nullrquest signing off</p><div class=blog-tags><a href=https://nullrequest.com//tags/self_hosting/>self_hosting</a>&nbsp;
<a href=https://nullrequest.com//tags/hugo/>hugo</a>&nbsp;</div></article><div id=disqus_thread></div><script type=text/javascript>(function(){if(window.location.hostname=="localhost")return;var dsq=document.createElement('script');dsq.type='text/javascript';dsq.async=true;var disqus_shortname='null-s-blog';dsq.src='//'+disqus_shortname+'.disqus.com/embed.js';(document.getElementsByTagName('head')[0]||document.getElementsByTagName('body')[0]).appendChild(dsq);})();</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com/ class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div><footer><div class=container><p class="credits copyright"><a href=https://nullrequest.com/about>Nullrequest</a>
&nbsp;&copy;
2020
&nbsp;/&nbsp;
<a href=https://nullrequest.com/>Null's blog</a>
&nbsp;&ndash;&nbsp;
<i class="fas fa-moon" id=dark-mode-toggle></i><p class="credits theme-by">Powered By <a href=https://gohugo.io>Hugo</a>&nbsp;Theme <a href=https://github.com/matsuyoshi30/harbor>Harbor</a></p></p></div></footer></body></html>