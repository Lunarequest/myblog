<!doctype html><html lang=en-us><head><meta charset=utf-8><title>Ultimate arch linux setup</title><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><link rel=alternate type=application/rss+xml href=https://nullrequest.com/index.xml title="Null's blog"><link id=dark-mode-theme rel=stylesheet href=https://nullrequest.com/css/dark.css><link rel=stylesheet href=https://nullrequest.com/fontawesome/css/all.min.css><script src=https://nullrequest.com/js/bundle.js></script><script src=https://nullrequest.com/js/instantpage.js type=module defer></script><meta name=generator content="Hugo 0.74.3"></head><body><header><nav class=navbar><div class=nav><a href=https://nullrequest.com/ class=nav-logo><img src=https://nullrequest.com/images/icon.jpg width=50 height=50 alt=Logo></a><ul class=nav-links><li><a href=https://nullrequest.com/about/ name=About><i class="fas fa-user fa-lg"></i></a></li><li><a href=https://nullrequest.com/search name=Search><i class="fas fa-search fa-lg"></i></a></li></ul></div></nav><div class=intro-header><div class=container><div class=post-heading><h1>Ultimate arch linux setup</h1><span class=meta-post><i class="fa fa-calendar-alt"></i>&nbsp;Jul 28, 2020</span></div></div></div></header><div class=container role=main><article class=article class=blog-post><h1 id=background>Background</h1><p>Recently after distro-hopping I came back to Arch linux. It was perfect for me and I really can&rsquo;t move to another distro without missing the AUR. After installing Arch I went through a few extra steps to add some features like secure boot(I know its not needed) and plymouth to add m to my setup. <strong>I am assuming you have used linux this does not and will not replace the arch wiki</strong>.</p><h2 id=the-arch-install>The arch install.</h2><p>This is the most difficult part of arch.I will not be making a guide for it as Arch linux changes very often and the best source is the Arch wiki. I know its scary but put in the hard work and you will be rewarded with a arch install.</p><h2 id=swapfiles>SwapFiles</h2><p>swapfiles are like swap partions but rather then use a partion it uses a file. Usually this is <code>/swapfile</code>. To start with you will need to make a file. If you use btrfs you will need to add set some permsions.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>$ sudo dd <span style=color:#66d9ef>if</span><span style=color:#f92672>=</span>/dev/zero of<span style=color:#f92672>=</span>/swapfile bs<span style=color:#f92672>=</span>1M count<span style=color:#f92672>=</span><span style=color:#ae81ff>512</span> status<span style=color:#f92672>=</span>progress
</code></pre></div><p>Change count to the size of ram you have if you want to hibernate. Next up we need to remove the read permissons on the file. Its supersingly easy to change this. <code>sudo chmod 600 /swapfile</code> will allow remove the read/write permssions. Next we need to format the file to make it a swap device. This step is very simple.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>$ sudo mkswap /swapfile
</code></pre></div><p>Next you should activate the swap device like this <code>sudo swapon /swapfile</code>. Finally you should edit the fstab file to ensure its actived on boot. You can edit the <code>/etc/fstab</code> file with you prefered text editor. Add the following line at the end and when you reboot your system should activate the swap device.</p><pre><code>/swapfile none swap defaults 0 0
</code></pre><h2 id=secure-boot>Secure boot</h2><p>I am using custom keys and have wiped the microsoft keys of my system for better security. If you want to keep these keys you will need to use preboot/shim. Look into the arch wiki on how to use them.
To start off we need to install <code>efitools</code></p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>$ sudo pacman -S efitools
</code></pre></div><p>I accutuly did everything here in a folder I created. The path is <code>/etc/secure-boot/</code>. I recomand doing the same. First we create a GUID</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>$ uuidgen --random &gt; GUID.txt
</code></pre></div><p>next up we create a Platform key</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>$ openssl req -newkey rsa:4096 -nodes -keyout PK.key -new -x509 -sha256 -days <span style=color:#ae81ff>3650</span> -subj <span style=color:#e6db74>&#34;/CN=my Platform Key/&#34;</span> -out PK.crt
$ openssl x509 -outform DER -in PK.crt -out PK.cer
$ cert-to-efi-sig-list -g <span style=color:#e6db74>&#34;</span><span style=color:#66d9ef>$(</span>&lt; GUID.txt<span style=color:#66d9ef>)</span><span style=color:#e6db74>&#34;</span> PK.crt PK.esl
$ sign-efi-sig-list -g <span style=color:#e6db74>&#34;</span><span style=color:#66d9ef>$(</span>&lt; GUID.txt<span style=color:#66d9ef>)</span><span style=color:#e6db74>&#34;</span> -k PK.key -c PK.crt PK PK.esl PK.auth
$ sign-efi-sig-list -g <span style=color:#e6db74>&#34;</span><span style=color:#66d9ef>$(</span>&lt; GUID.txt<span style=color:#66d9ef>)</span><span style=color:#e6db74>&#34;</span> -c PK.crt -k PK.key PK /dev/null rm_PK.auth <span style=color:#75715e># this is to allow the key to be removed in the future</span>
</code></pre></div><p>Next the Key exchange key or KEK</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>$ openssl req -newkey rsa:4096 -nodes -keyout KEK.key -new -x509 -sha256 -days <span style=color:#ae81ff>3650</span> -subj <span style=color:#e6db74>&#34;/CN=my Key Exchange Key/&#34;</span> -out KEK.crt
$ openssl x509 -outform DER -in KEK.crt -out KEK.cer
$ cert-to-efi-sig-list -g <span style=color:#e6db74>&#34;</span><span style=color:#66d9ef>$(</span>&lt; GUID.txt<span style=color:#66d9ef>)</span><span style=color:#e6db74>&#34;</span> KEK.crt KEK.esl
$ sign-efi-sig-list -g <span style=color:#e6db74>&#34;</span><span style=color:#66d9ef>$(</span>&lt; GUID.txt<span style=color:#66d9ef>)</span><span style=color:#e6db74>&#34;</span> -k PK.key -c PK.crt KEK KEK.esl KEK.auth
</code></pre></div><p>Finally the Signature Database key.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>$ openssl req -newkey rsa:4096 -nodes -keyout db.key -new -x509 -sha256 -days <span style=color:#ae81ff>3650</span> -subj <span style=color:#e6db74>&#34;/CN=my Signature Database key/&#34;</span> -out db.crt
$ openssl x509 -outform DER -in db.crt -out db.cer
$ cert-to-efi-sig-list -g <span style=color:#e6db74>&#34;</span><span style=color:#66d9ef>$(</span>&lt; GUID.txt<span style=color:#66d9ef>)</span><span style=color:#e6db74>&#34;</span> db.crt db.esl
$ sign-efi-sig-list -g <span style=color:#e6db74>&#34;</span><span style=color:#66d9ef>$(</span>&lt; GUID.txt<span style=color:#66d9ef>)</span><span style=color:#e6db74>&#34;</span> -k KEK.key -c KEK.crt db db.esl db.auth
</code></pre></div><p>Now we need to sign the kernels and efi binaries.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>$ sudo sbsign --key db.key --cert db.crt --output /boot/vmlinuz-linux /boot/vmlinuz-linux
$ sudo sbsign --key db.key --cert db.crt --output esp/EFI/BOOT/BOOTX64.EFI esp/EFI/BOOT/BOOTX64.EFI
</code></pre></div><p>You will need to do this everytime you update the kernel or bootloader. I used a pacman hook to do this. I also moved all the keys to /etc/secure-boot</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>$ sudo nano /etc/pacman.d/hooks/99-secureboot.hook
</code></pre></div><p>My hook is the following</p><pre><code>[Trigger]
Operation = Install
Operation = Upgrade
Type = Package
Target = linux
Target = systemd

[Action]
Description = Signing Kernel for SecureBoot
When = PostTransaction
Exec = /usr/bin/sh -c &quot;/usr/bin/find /boot/ -type f \( -name 'vmlinuz-*' -o -name 'systemd*' \) -exec /usr/bin/sh -c 'if ! /usr/bin/sbverify --list {} 2&gt;/dev/null | /usr/bin/grep -q \&quot;signature certificates\&quot;; then /usr/bin/sbsign --key /etc/secure-boot/db.key --cert /etc/secure-boot/db.crt --output {} {}; fi' \;&quot;
Depends = sbsigntools
Depends = findutils
Depends = grep
</code></pre><p>You should also copy all the keys to the /boot partion.
Next you need to put your firmware into setup mode and enroll the keys. You can follow this guide on how to enroll the keys <a href=http://www.rodsbooks.com/efi-bootloaders/controlling-sb.html#setuputil>www.rodsbooks.com/efi-bootloaders/controlling-sb.html#setuputil</a>.</p><h2 id=plymouth>Plymouth</h2><p>Fist we need to install a aur helper. I prefer yay but you can use any helper or manully git clone and <code>makepkg</code> each package on your own.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>$ git clone https://aur.archlinux.org/yay.git
</code></pre></div><p>These packages are a must if you want to install any aur package.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>$ sudo pacman -S fakeroot binuitls
</code></pre></div><p>Next to build and install yay. run these commands</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>$ makepkg -si
</code></pre></div><p>After this we can install plymouth.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>$ yay plymouth
</code></pre></div><p>You can install the git or stable version. Next you need to edit the <code>/etc/mkinitcpio.conf</code>.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>$ sudo nano /etc/mkinitcpio.conf 
</code></pre></div><p>you need to add the plymouth hook to the HOOKS section <code>HOOKS=(base udev plymouth ...)</code>. You might also need to add your drivers kernel module.</p><p>At this point its time to get a theme for the plymouth screen. I used this <a href=https://aur.archlinux.org/packages/plymouth-theme-darth-vader-git/>theme</a>. However you can use the one you perfer.</p><p>You can get a list of choices using the following command</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>$ plymouth-set-default-theme -l
</code></pre></div><p>Finally to set the theme run</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>$ sudo  plymouth-set-default-theme -R theme
</code></pre></div><p>Add this to the options line in the arch.conf in the /boot partition. <code>quiet splash loglevel=3 rd.udev.log_priority=3 vt.global_cursor_default=0</code>
After this you can reboot the system and you should have your theme shown when you boot up.</p><h2 id=hibrenation>Hibrenation</h2><p>Hibrenation is a <del>usefull</del> requirment on laptops. When a laptop enters hibernation it saves the contents of ram to the hdd/sdd saving power but speeding up boot time. On arch linux you need to add kernel hooks and parameters to tell the system on how to resume. To start off we can add the mkinitcpio hook. You should open the <code>/etc/mkinitcpio.conf</code> file in a text editor and updated the hooks.</p><pre><code class=language-conf data-lang=conf>HOOKS=(base udev plymouth autodetect modconf block filesystems resume keyboard fsck)
</code></pre><p>The hooks should look like this now. Next we need to add a kernel parameter so the kernel knows where to resume from. However before this we need to find the &ldquo;offset&rdquo; of the swapfile. To do this we can use <code>filefrag</code>.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>Filesystem type is: ef53
File size of /swapfile is <span style=color:#ae81ff>8388608000</span> <span style=color:#f92672>(</span><span style=color:#ae81ff>2048000</span> blocks of <span style=color:#ae81ff>4096</span> bytes<span style=color:#f92672>)</span>
 ext:     logical_offset:        physical_offset: length:   expected: flags:
   0:        0..    6143:     321536..    327679:   6144:            
   1:     6144..   12287:     403456..    409599:   6144:     327680:
   2:    12288..   14335:     466944..    468991:   2048:     409600:
   3:    14336..   16383:     522240..    524287:   2048:     468992:
   4:    16384..   47103:     559104..    589823:  30720:     524288:
   5:    47104..   49151:     673792..    675839:   2048:     589824:
   6:    49152..   59391:     677888..    688127:  10240:     675840:
   7:    59392..   83967:     696320..    720895:  24576:     688128:
   8:    83968..   86015:     735232..    737279:   2048:     720896:
</code></pre></div><p>You should look for the first physical_offset value. In my case it was 321536. Now we are ready to add our kernel parameters. There are 2 parameters we need to add the <code>resume</code> parameter and the <code>resume_offset</code> parameter. For the resume parametere you need to use the UUID of the partion the swapfile is on. your parameter should look like this.<code>resume=UUID=19a7a7b7-04d9-4abc-b1bf-8d53ea7de04e resume_offset=321536</code></p><h2 id=final-thoughts>Final thoughts</h2><p>I know it was a bit long but I spent a long time fixing issues and getting things working. I really enjoy arch and I hope people find this informing and enjoy setting up arch.</p><p>â€” This is nullrquest signing off</p><div class=blog-tags><a href=https://nullrequest.com//tags/arch/>arch</a>&nbsp;
<a href=https://nullrequest.com//tags/linux/>linux</a>&nbsp;
<a href=https://nullrequest.com//tags/secureboot/>secureboot</a>&nbsp;
<a href=https://nullrequest.com//tags/plymouth/>plymouth</a>&nbsp;</div></article><div id=disqus_thread></div><script type=text/javascript>(function(){if(window.location.hostname=="localhost")return;var dsq=document.createElement('script');dsq.type='text/javascript';dsq.async=true;var disqus_shortname='null-s-blog';dsq.src='//'+disqus_shortname+'.disqus.com/embed.js';(document.getElementsByTagName('head')[0]||document.getElementsByTagName('body')[0]).appendChild(dsq);})();</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com/ class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div><footer><div class=container><p class="credits copyright"><a href=https://nullrequest.com/about>Nullrequest</a>
&nbsp;&copy;
2020
&nbsp;/&nbsp;
<a href=https://nullrequest.com/>Null's blog</a>
&nbsp;&ndash;&nbsp;
<i class="fas fa-moon" id=dark-mode-toggle></i><p class="credits theme-by">Powered By <a href=https://gohugo.io>Hugo</a>&nbsp;Theme <a href=https://github.com/matsuyoshi30/harbor>Harbor</a></p></p></div></footer></body></html>