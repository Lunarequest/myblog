<!doctype html><html lang=en-us><head><meta charset=utf-8><title>Arch install automation</title><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><link rel=alternate type=application/rss+xml href=https://nullrequest.com/index.xml title="Null's blog"><link id=dark-mode-theme rel=stylesheet href=https://nullrequest.com/css/dark.css><link rel=stylesheet href=https://nullrequest.com/fontawesome/css/all.min.css><script src=https://nullrequest.com/js/bundle.js></script><script src=https://nullrequest.com/js/instantpage.js type=module defer></script><meta name=generator content="Hugo 0.74.3"></head><body><header><nav class=navbar><div class=nav><a href=https://nullrequest.com/ class=nav-logo><img src=https://nullrequest.com/images/icon.jpg width=50 height=50 alt=Logo></a><ul class=nav-links><li><a href=https://nullrequest.com/about/ name=About><i class="fas fa-user fa-lg"></i></a></li><li><a href=https://nullrequest.com/search name=Search><i class="fas fa-search fa-lg"></i></a></li></ul></div></nav><div class=intro-header><div class=container><div class=post-heading><h1>Arch install automation</h1><span class=meta-post><i class="fa fa-calendar-alt"></i>&nbsp;Aug 6, 2020</span></div></div></div></header><div class=container role=main><article class=article class=blog-post><h2 id=background>background</h2><p>I have a OEM desktop that I use as a headless(without a display) server. I found that I nuke this server very often when I mess something up and have to reinstall. With my recent move switching to Arch as my primary operating system. Reinstalling became a hassel. This post will take a diffrent approch. Rather then give instructions on how to make/build everything. I will talk about what I did and why I did that.</p><h2 id=the-plan>The plan</h2><p>First I need to make a custom iso. This iso had to boot regularly some how tell my laptop its ip and finally get sshed into by ansible which will allow ansible to install arch for me. I broke the problem down into stages
stage 1. get the ip
stage 2. auth in ssh without password
stage 3. install arch</p><h2 id=stage-1>Stage 1</h2><p>Stage 1 was the simplest part of the project. I started with finding out how I could get my IP. For this section I exmployed Python. I used python due to my fimilarity with it. To get the IP adress I used <code>socket</code>. This is the function I used to get my IP.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>get_ip</span>():
    s <span style=color:#f92672>=</span> socket<span style=color:#f92672>.</span>socket(socket<span style=color:#f92672>.</span>AF_INET, socket<span style=color:#f92672>.</span>SOCK_DGRAM)
    s<span style=color:#f92672>.</span>connect((<span style=color:#e6db74>&#34;8.8.8.8&#34;</span>, <span style=color:#ae81ff>80</span>))
    ip <span style=color:#f92672>=</span> s<span style=color:#f92672>.</span>getsockname()[<span style=color:#ae81ff>0</span>]
    s<span style=color:#f92672>.</span>close()
    <span style=color:#66d9ef>return</span> ip
</code></pre></div><p>Its a nifty little piece of code that pings googles DNS server and then gets the current ip from the socket and closes the socket. The next part stumped me for a while. How would I send the ip to my laptop. After about 5 minutes of thinking I though maybe I could run a Django webserver. After 5 more minutes of thinking I came to the conclusion that while the idea was right using a webserver would be good django was overkill. Enter our next contender flask. Flask is the arch of the python web dev world. While Django neatly handles 99% of the work flask is the opposite. You need to configure and handle everything(well almost everything).</p><p>I Would like to show my flask code but its nothing special. It recives the the request (a get in this case) and prints the ip which is sent as a parameter of the get request. To send the get request I used the <code>requests</code> python module. the function for this was suprisngly simple to use.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>send_ip</span>(ip):
    URL <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;http://127.0.0.1:5000&#34;</span>
    PARAMS <span style=color:#f92672>=</span> {<span style=color:#e6db74>&#34;ip&#34;</span>: ip}
    r <span style=color:#f92672>=</span> requests<span style=color:#f92672>.</span>get(url<span style=color:#f92672>=</span>URL, data<span style=color:#f92672>=</span>PARAMS)
    <span style=color:#66d9ef>print</span>(r)
    <span style=color:#66d9ef>print</span>(r<span style=color:#f92672>.</span>text)
</code></pre></div><p>currently the url is set to localhost but you can change it to the ip of your system. This is where my first road block was hit. I orginally planed to use systemd to load up and run the program for me. Sadly the systems ip isn&rsquo;t set until the DHCP negtations are run made by <code>dhcpcd</code>. So I moved to plan b using the zshrc. At this point I spent 2 days lerning, making and testing a custom arch iso. At this point I realised that I could tackel stage 2 with the iso. The only side effect present is when you ssh you will not see a propmt on the iso.</p><h2 id=stage-2>Stage 2</h2><p>A password isn&rsquo;t the only way to login to a remote host using ssh. The alterntive more secure method is a SSH key. A key pair(one private and one public) can be made fairly quickly. I recomand follow the guide by github on how to set it up. So I add a section in the iso to copy my key into the iso. allowing me to login and execute commands as root without ever inputing the password.</p><h2 id=stage-3>Stage 3</h2><p>This was what held me back for a short while(okay it wasn&rsquo;t a short while it was a month). At one point I thought of using <code>Chef</code> instead of <code>ansible</code>. While I did start porting to chef. It quickly ended becuase chef just doesn&rsquo;t have modules like asibles parted module. The install is pretty standard except instead of using <code>arch-chroot /mnt</code> you have to run command outside and when it needs to be run inside a chroot you use <code>arch-chroot /mnt command</code>. There was 2 problems that really stumpped me when I ran into them. The first one was the grub install. I used grub over systemd because the server only had bios support.</p><p>I discorved you dont give <code>grub-install</code> a partion but rather the entier disk like <code>grub-install /dev/sda</code>. After this the install was pretty smooth sailing. Until I hit the user creation section. Currently I haven&rsquo;t figured out how to fix the issue but the one solution I am trying to get working is <code>chpasswd</code>. If someone figures out how it works please do hit me up. I really would like to solve it. I will be uploading everything to my github so anyone can use it. One last thing. If you want to install arch do it yourself. Do your research and it will pay off. Installing arch teachs you alot about how linux works. Also don&rsquo;t use arch as your first Linux distro use linux mint or pop os</p><p>â€” This is nullrequest signing off</p><div class=blog-tags><a href=https://nullrequest.com//tags/arch/>arch</a>&nbsp;
<a href=https://nullrequest.com//tags/automation/>automation</a>&nbsp;
<a href=https://nullrequest.com//tags/ansible/>ansible</a>&nbsp;</div></article><div id=disqus_thread></div><script type=text/javascript>(function(){if(window.location.hostname=="localhost")return;var dsq=document.createElement('script');dsq.type='text/javascript';dsq.async=true;var disqus_shortname='null-s-blog';dsq.src='//'+disqus_shortname+'.disqus.com/embed.js';(document.getElementsByTagName('head')[0]||document.getElementsByTagName('body')[0]).appendChild(dsq);})();</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com/ class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div><footer><div class=container><p class="credits copyright"><a href=https://nullrequest.com/about>Nullrequest</a>
&nbsp;&copy;
2020
&nbsp;/&nbsp;
<a href=https://nullrequest.com/>Null's blog</a>
&nbsp;&ndash;&nbsp;
<i class="fas fa-moon" id=dark-mode-toggle></i><p class="credits theme-by">Powered By <a href=https://gohugo.io>Hugo</a>&nbsp;Theme <a href=https://github.com/matsuyoshi30/harbor>Harbor</a></p></p></div></footer></body></html>